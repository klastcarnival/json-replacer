<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON ë‹¨ì–´ ì¹˜í™˜ ë° ì‚­ì œ ë„êµ¬ (ì ‘ê¸°/í´ê¸°)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3499db; padding-bottom: 10px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #34495e; }
        input[type="file"], input[type="text"], button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; transition: background-color 0.3s; margin-left: 5px; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        /* JSON í‘œì‹œ ì˜ì—­ */
        #jsonDisplay { 
            width: 100%; height: 300px; margin-top: 10px; padding: 10px; 
            border: 1px solid #ccc; box-sizing: border-box; overflow: auto; 
            background-color: #fff; white-space: pre; font-family: monospace; line-height: 1.5;
        }
        
        /* í˜•ê´‘íœ ìŠ¤íƒ€ì¼ */
        mark { background-color: #f1c40f; padding: 0 2px; border-radius: 3px; }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì¸ë±ìŠ¤ í‘œì‹œ ì˜ì—­ */
        #searchResultContainer { margin-top: 15px; }
        
        /* Details/Summary ìŠ¤íƒ€ì¼ */
        details { border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; background-color: #fff; }
        summary { 
            padding: 10px; background-color: #ecf0f1; cursor: pointer; 
            font-weight: bold; list-style-type: 'â–¶ '; /* ë‹«í˜”ì„ ë•Œ í™”ì‚´í‘œ */
        }
        details[open] > summary { 
            list-style-type: 'â–¼ '; /* ì—´ë ¸ì„ ë•Œ í™”ì‚´í‘œ */
        }
        
        /* ì¸ë±ìŠ¤ í•­ëª© ìŠ¤íƒ€ì¼ */
        #searchResultList { padding: 10px; }
        .index-item { 
            border: 1px solid #e0e0e0; padding: 10px; 
            margin-bottom: 10px; border-radius: 4px; background-color: #fcfcfc;
        }
        .index-title { font-weight: bold; color: #34495e; margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .index-content { font-family: monospace; white-space: pre-wrap; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¬ JSON ë‹¨ì–´ ì¹˜í™˜ ë° ì‚­ì œ ë„êµ¬</h1>
    
    <div class="section">
        <label for="fileInput">1ï¸âƒ£ JSON íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <div class="section">
        <label>2ï¸âƒ£ ë‹¨ì–´ ê²€ìƒ‰ ë° ì¸ë±ìŠ¤ ì¶”ì¶œ</label>
        <input type="text" id="findWord" placeholder="ê²€ìƒ‰í•  ë‹¨ì–´" style="width: 35%;">
        <button onclick="searchWord()" id="searchButton" disabled>ë‹¨ì–´ ê²€ìƒ‰ ë° ì¸ë±ìŠ¤ ì¶”ì¶œ</button>
        <p id="searchCount" style="margin-top: 10px; font-weight: bold; display: none;"></p>
        
        <div id="searchResultContainer">
            </div>
    </div>

    <div class="section">
        <label>3ï¸âƒ£ ë‹¨ì–´ ì¹˜í™˜ ë˜ëŠ” ì‚­ì œ ì‹¤í–‰</label>
        <input type="text" id="replaceWord" placeholder="ë°”ê¿€ ë‹¨ì–´ (ë¹„ì›Œë‘ë©´ ì‚­ì œ)" style="width: 35%;">
        <button onclick="replaceAndDisplay()" id="replaceButton" disabled>ì¹˜í™˜ / ì‚­ì œ ì‹¤í–‰</button>
        <p style="margin-top: 10px; color: #888;">* **ë°”ê¿€ ë‹¨ì–´** ì¹¸ì„ ë¹„ì›Œë‘ë©´ **ì°¾ì€ ë‹¨ì–´**ê°€ ì™„ì „íˆ **ì‚­ì œ**ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="section">
        <label>4ï¸âƒ£ ìˆ˜ì •ëœ JSON ë‚´ìš© (í˜•ê´‘íœ í‘œì‹œ)</label>
        <div id="jsonDisplay">JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="section">
        <label>5ï¸âƒ£ ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</label>
        <button onclick="downloadJsonFile()" id="downloadButton" disabled>ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <p id="statusMessage" style="color: #c0392b; margin-top: 15px; font-weight: bold;"></p>

</div>

<script>
    let currentJsonObject = null; // í˜„ì¬ (ìˆ˜ì •ëœ) JSON ê°ì²´ (ë‹¤ìš´ë¡œë“œìš©)
    let replacementCount = 0; // ì¹˜í™˜ëœ ë‹¨ì–´ ìˆ˜ ì¹´ìš´í„°

    // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” í•¨ìˆ˜
    function updateButtonStates() {
        const isLoaded = currentJsonObject !== null;
        document.getElementById('searchButton').disabled = !isLoaded;
        document.getElementById('replaceButton').disabled = !isLoaded;
        document.getElementById('downloadButton').disabled = !isLoaded;
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonText = e.target.result;
                currentJsonObject = JSON.parse(jsonText);
                
                const formattedText = JSON.stringify(currentJsonObject, null, 2);
                document.getElementById('jsonDisplay').textContent = formattedText;
                document.getElementById('statusMessage').textContent = 'âœ… JSON íŒŒì¼ ë¡œë“œ ì„±ê³µ. ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”.';
                document.getElementById('searchCount').style.display = 'none';
                document.getElementById('searchResultContainer').innerHTML = ''; // ì¸ë±ìŠ¤ ëª©ë¡ ì´ˆê¸°í™”
                updateButtonStates();
            } catch (error) {
                document.getElementById('statusMessage').textContent = 'âš ï¸ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                document.getElementById('jsonDisplay').textContent = 'JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                currentJsonObject = null;
                updateButtonStates();
            }
        };
        reader.readAsText(file);
    });

    /**
     * JSON ê°ì²´ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íƒìƒ‰í•˜ë©° ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•˜ê³  ì¸ë±ìŠ¤ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜.
     */
    function searchAndExtract(data, find, results, currentPath = '') {
        const regex = new RegExp(find, 'g');
        
        if (typeof data === 'string') {
            if (data.match(regex)) {
                results.push({
                    path: currentPath,
                    content: data
                });
            }
        } else if (Array.isArray(data)) {
            data.forEach((item, index) => {
                searchAndExtract(item, find, results, `${currentPath}[${index}]`);
            });
        } else if (typeof data === 'object' && data !== null) {
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    searchAndExtract(data[key], find, results, `${currentPath}.${key}`);
                }
            }
        }
    }

    // 2. ë‹¨ì–´ ê²€ìƒ‰ ë° ì¸ë±ìŠ¤ ì¶”ì¶œ ê¸°ëŠ¥
    function searchWord() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë¨¼ì € JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
            return;
        }

        const findWord = document.getElementById('findWord').value.trim();
        if (!findWord) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ê²€ìƒ‰í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        const results = [];
        searchAndExtract(currentJsonObject, findWord, results);

        const totalCount = results.length;
        document.getElementById('searchCount').innerHTML = `ğŸ” ê²€ìƒ‰ ê²°ê³¼: "${findWord}"(ì€)ëŠ” ì´ **${totalCount}**ê°œ í¬í•¨ëœ í•­ëª©ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        document.getElementById('searchCount').style.display = 'block';
        document.getElementById('statusMessage').textContent = `ğŸ” ë‹¨ì–´ ê²€ìƒ‰ ë° ì¸ë±ìŠ¤ ì¶”ì¶œ ì™„ë£Œ.`;
        
        // ì¸ë±ìŠ¤ ëª©ë¡ ì ‘ê¸°/í´ê¸° ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸
        const container = document.getElementById('searchResultContainer');
        container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

        if (totalCount > 0) {
            // details ìš”ì†Œ ìƒì„±
            const detailsElement = document.createElement('details');
            
            // summary ìš”ì†Œ ìƒì„±
            const summaryElement = document.createElement('summary');
            summaryElement.textContent = `ì´ ${totalCount}ê°œ í•­ëª©ì˜ ìƒì„¸ ê²½ë¡œ ë° ë‚´ìš© ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)`;
            
            // ëª©ë¡ ì»¨í…Œì´ë„ˆ
            const resultListDiv = document.createElement('div');
            resultListDiv.id = 'searchResultList';
            
            results.forEach((item, idx) => {
                const indexItem = document.createElement('div');
                indexItem.className = 'index-item';
                
                const pathDisplay = item.path.replace(/^\./, '').replace(/\[(\d+)\]/g, '[$1]').replace(/\.([a-zA-Z0-9_]+)/g, '.$1');

                // ë‚´ìš©ì— í˜•ê´‘íœ ì ìš©
                const regex = new RegExp(findWord, 'g');
                const highlightedContent = item.content.replace(regex, `<mark>${findWord}</mark>`);

                indexItem.innerHTML = `
                    <div class="index-title">í•­ëª© ${idx + 1} / ê²½ë¡œ: ${pathDisplay}</div>
                    <div class="index-content">${highlightedContent}</div>
                `;
                resultListDiv.appendChild(indexItem);
            });

            detailsElement.appendChild(summaryElement);
            detailsElement.appendChild(resultListDiv);
            container.appendChild(detailsElement);
        } else {
            container.innerHTML = `<p style="color: #7f8c8d; padding: 5px 0;">ê²€ìƒ‰ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
        
        // ë©”ì¸ ë””ìŠ¤í”Œë ˆì´ì— í˜•ê´‘íœ í‘œì‹œ
        highlightDisplayContent(currentJsonObject, findWord, findWord);
    }

    /**
     * JSON ê°ì²´ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íƒìƒ‰í•˜ë©° ë¬¸ìì—´ ê°’ì„ ì¹˜í™˜/ì‚­ì œí•˜ëŠ” í•¨ìˆ˜ (ìˆœìˆ˜ ë°ì´í„°ë§Œ ì²˜ë¦¬)
     */
    function deepReplace(data, find, replace, countObj) {
        if (typeof data === 'string') {
            if (!find) return data; 

            const actualReplace = replace || ''; 
            const regex = new RegExp(find, 'g');
            
            const matches = data.match(regex);
            if (matches) {
                countObj.count += matches.length;
            }
            return data.replace(regex, actualReplace);
        } else if (Array.isArray(data)) {
            return data.map(item => deepReplace(item, find, replace, countObj));
        } else if (typeof data === 'object' && data !== null) {
            const newObject = {};
            for (const key in data) {
                newObject[key] = deepReplace(data[key], find, replace, countObj);
            }
            return newObject;
        }
        return data;
    }

    // JSON í…ìŠ¤íŠ¸ë¥¼ í¬ë§·íŒ…í•˜ê³  íŠ¹ì • ë‹¨ì–´ì— í˜•ê´‘íœì„ ì ìš©í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function highlightDisplayContent(jsonObject, find, replace) {
        let displayJsonText = JSON.stringify(jsonObject, null, 2);
        
        // ì¹˜í™˜ì´ ì•„ë‹Œ ì‚­ì œì¸ ê²½ìš°, í˜•ê´‘íœì€ findWordì— ì ìš©ë˜ì–´ì•¼ í•¨.
        const highlightTarget = replace || find;

        // HTML íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
        const escapedText = displayJsonText.replace(/&/g, '&amp;')
                                          .replace(/</g, '&lt;')
                                          .replace(/>/g, '&gt;');
        
        // ì¹˜í™˜ëœ/ê²€ìƒ‰ëœ ë‹¨ì–´ì—ë§Œ <mark> íƒœê·¸ ì‚½ì…
        const regex = new RegExp(highlightTarget, 'g');
        const highlightedText = escapedText.replace(regex, `<mark>${highlightTarget}</mark>`);

        document.getElementById('jsonDisplay').innerHTML = highlightedText;
    }

    // 3. ë‹¨ì–´ ì¹˜í™˜ ë° ì‚­ì œ ì‹¤í–‰ ê¸°ëŠ¥
    function replaceAndDisplay() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë¨¼ì € JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
            return;
        }

        const findWord = document.getElementById('findWord').value.trim();
        const replaceWord = document.getElementById('replaceWord').value.trim(); 

        if (!findWord) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ê²€ìƒ‰í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }
        
        try {
            const countObj = { count: 0 };
            const modifiedObjectForDownload = deepReplace(
                JSON.parse(JSON.stringify(currentJsonObject)),
                findWord, 
                replaceWord, 
                countObj
            );
            
            currentJsonObject = modifiedObjectForDownload; 
            const replacementCount = countObj.count; 
            
            const displayTarget = replaceWord || findWord;
            highlightDisplayContent(currentJsonObject, findWord, displayTarget);
            
            let actionType = replaceWord ? "ì¹˜í™˜" : "ì‚­ì œ";
            let statusMessage = replaceWord ? 
                `âœ… ë‹¨ì–´ ì¹˜í™˜ ì™„ë£Œ: "${findWord}" -> "${replaceWord}". ì´ **${replacementCount}**ê°œ ì¹˜í™˜ë¨.` :
                `âœ… ë‹¨ì–´ ì‚­ì œ ì™„ë£Œ: "${findWord}"(ì´)ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ **${replacementCount}**ê°œ ì²˜ë¦¬ë¨.`;
                
            document.getElementById('statusMessage').textContent = statusMessage;
            
            // ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ ë©”ì‹œì§€
            document.getElementById('searchCount').innerHTML = `âœ… ${actionType} ì™„ë£Œ. ì´ **${replacementCount}**ê°œì˜ ë‹¨ì–´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            document.getElementById('searchResultContainer').innerHTML = `<p style="color: #7f8c8d; padding: 5px 0;">(ì—…ë°ì´íŠ¸ëœ ì¸ë±ìŠ¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ë ¤ë©´ 'ë‹¨ì–´ ê²€ìƒ‰'ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.)</p>`;

        } catch (error) {
            document.getElementById('statusMessage').textContent = 'âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
            console.error(error);
        }
    }

    // 5. ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (ë³€ê²½ ì—†ìŒ)
    function downloadJsonFile() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        const jsonText = JSON.stringify(currentJsonObject, null, 2);
        
        const blob = new Blob([jsonText], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'modified_chat.json';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        document.getElementById('statusMessage').textContent = 'â¬‡ï¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: modified_chat.json';
    }
</script>

</body>
</html>
