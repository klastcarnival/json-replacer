<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON ë‹¨ì–´ ì¹˜í™˜ ë„êµ¬ (ìµœì¢… ê°œì„ )</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #34495e; }
        input[type="file"], input[type="text"], button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; transition: background-color 0.3s; margin-left: 5px; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #jsonDisplay { 
            width: 100%; 
            height: 300px; 
            margin-top: 10px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            box-sizing: border-box; 
            overflow: auto; 
            background-color: #fff; 
            white-space: pre; 
            font-family: monospace; 
            line-height: 1.5;
        }
        mark { background-color: #f1c40f; padding: 0 2px; border-radius: 3px; }
        .result-box { padding: 10px; background-color: #ecf0f1; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¬ JSON ë‹¨ì–´ ì¹˜í™˜ ë„êµ¬</h1>
    
    <div class="section">
        <label for="fileInput">1ï¸âƒ£ JSON íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <div class="section">
        <label>2ï¸âƒ£ ë‹¨ì–´ ê²€ìƒ‰ ë° ê°œìˆ˜ í™•ì¸</label>
        <input type="text" id="findWord" placeholder="ê²€ìƒ‰í•  ë‹¨ì–´" style="width: 35%;">
        <button onclick="searchWord()" id="searchButton" disabled>ë‹¨ì–´ ê²€ìƒ‰</button>
        <div id="searchResult" class="result-box" style="display: none;"></div>
    </div>

    <div class="section">
        <label>3ï¸âƒ£ ì¹˜í™˜ ë‹¨ì–´ ì…ë ¥ ë° ì‹¤í–‰</label>
        <input type="text" id="replaceWord" placeholder="ë°”ê¿€ ë‹¨ì–´" style="width: 35%;">
        <button onclick="replaceAndDisplay()" id="replaceButton" disabled>ë‹¨ì–´ ì¹˜í™˜ ì‹¤í–‰</button>
        <p style="margin-top: 10px; color: #888;">* ì¹˜í™˜ í›„ ì•„ë˜ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë˜ê³  í˜•ê´‘íœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <div class="section">
        <label>4ï¸âƒ£ ìˆ˜ì •ëœ JSON ë‚´ìš© (í˜•ê´‘íœ í‘œì‹œ)</label>
        <div id="jsonDisplay">JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="section">
        <label>5ï¸âƒ£ ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</label>
        <button onclick="downloadJsonFile()" id="downloadButton" disabled>ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <p id="statusMessage" style="color: #c0392b; margin-top: 15px; font-weight: bold;"></p>

</div>

<script>
    let currentJsonObject = null; // í˜„ì¬ (ìˆ˜ì •ëœ) JSON ê°ì²´ (ë‹¤ìš´ë¡œë“œìš©)
    let originalJsonText = ''; // ìµœì´ˆ ë¡œë“œëœ JSON í…ìŠ¤íŠ¸
    let lastFindWord = ''; // ë§ˆì§€ë§‰ìœ¼ë¡œ ê²€ìƒ‰/ì¹˜í™˜ì— ì‚¬ìš©ëœ ë‹¨ì–´
    let lastReplaceWord = ''; // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¹˜í™˜ì— ì‚¬ìš©ëœ ë‹¨ì–´

    // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” í•¨ìˆ˜
    function updateButtonStates() {
        const isLoaded = currentJsonObject !== null;
        document.getElementById('searchButton').disabled = !isLoaded;
        document.getElementById('replaceButton').disabled = !isLoaded;
        document.getElementById('downloadButton').disabled = !isLoaded;
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                originalJsonText = e.target.result;
                currentJsonObject = JSON.parse(originalJsonText);
                
                const formattedText = JSON.stringify(currentJsonObject, null, 2);
                document.getElementById('jsonDisplay').textContent = formattedText;
                document.getElementById('statusMessage').textContent = 'âœ… JSON íŒŒì¼ ë¡œë“œ ì„±ê³µ. ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”.';
                document.getElementById('searchResult').style.display = 'none';
                updateButtonStates();
            } catch (error) {
                document.getElementById('statusMessage').textContent = 'âš ï¸ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                document.getElementById('jsonDisplay').textContent = 'JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                currentJsonObject = null;
                updateButtonStates();
            }
        };
        reader.readAsText(file);
    });

    /**
     * JSON ê°ì²´ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íƒìƒ‰í•˜ë©° ë¬¸ìì—´ ê°’ ë‚´ì—ì„œ ë‹¨ì–´ ê°œìˆ˜ë¥¼ ì„¸ëŠ” í•¨ìˆ˜
     */
    function countWord(data, find) {
        let count = 0;
        const regex = new RegExp(find, 'g');

        if (typeof data === 'string') {
            const matches = data.match(regex);
            if (matches) {
                count += matches.length;
            }
        } else if (Array.isArray(data)) {
            data.forEach(item => {
                count += countWord(item, find);
            });
        } else if (typeof data === 'object' && data !== null) {
            for (const key in data) {
                count += countWord(data[key], find);
            }
        }
        return count;
    }

    // 2. ë‹¨ì–´ ê²€ìƒ‰ ê¸°ëŠ¥
    function searchWord() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë¨¼ì € JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
            return;
        }

        const findWord = document.getElementById('findWord').value.trim();
        if (!findWord) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ê²€ìƒ‰í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        lastFindWord = findWord;
        
        // ê²€ìƒ‰ì€ í˜„ì¬ ë¡œë“œëœ ê°ì²´(ìˆ˜ì •ëœ ë‚´ìš© í¬í•¨)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰
        const totalCount = countWord(currentJsonObject, findWord);

        const resultDiv = document.getElementById('searchResult');
        resultDiv.innerHTML = `ê²€ìƒ‰ ê²°ê³¼: "${findWord}"(ì€)ëŠ” ì´ **${totalCount}**ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        resultDiv.style.display = 'block';
        document.getElementById('statusMessage').textContent = `ğŸ” ë‹¨ì–´ ê²€ìƒ‰ ì™„ë£Œ.`;

        // ê²€ìƒ‰ëœ ë‹¨ì–´ë¥¼ í˜•ê´‘íœìœ¼ë¡œ í‘œì‹œ (ì¹˜í™˜ì€ í•˜ì§€ ì•Šê³  í‘œì‹œë§Œ)
        highlightDisplayContent(currentJsonObject, findWord, findWord);
    }

    /**
     * JSON ê°ì²´ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íƒìƒ‰í•˜ë©° ë¬¸ìì—´ ê°’ì„ ì¹˜í™˜í•˜ëŠ” í•¨ìˆ˜ (ìˆœìˆ˜ ë°ì´í„°ë§Œ ì²˜ë¦¬)
     */
    function deepReplace(data, find, replace, countObj) {
        if (typeof data === 'string') {
            if (!find) return data; 

            const regex = new RegExp(find, 'g');
            
            // ì¹˜í™˜ íšŸìˆ˜ ì¹´ìš´íŠ¸
            const matches = data.match(regex);
            if (matches) {
                countObj.count += matches.length;
            }

            // ì‹¤ì œ ì¹˜í™˜ ì‘ì—…
            return data.replace(regex, replace);
        } else if (Array.isArray(data)) {
            return data.map(item => deepReplace(item, find, replace, countObj));
        } else if (typeof data === 'object' && data !== null) {
            const newObject = {};
            for (const key in data) {
                newObject[key] = deepReplace(data[key], find, replace, countObj);
            }
            return newObject;
        }
        return data;
    }

    // JSON í…ìŠ¤íŠ¸ë¥¼ í¬ë§·íŒ…í•˜ê³  íŠ¹ì • ë‹¨ì–´ì— í˜•ê´‘íœì„ ì ìš©í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function highlightDisplayContent(jsonObject, find, replace) {
        // 1. ìˆœìˆ˜ JSON í…ìŠ¤íŠ¸ í¬ë§·íŒ…
        let displayJsonText = JSON.stringify(jsonObject, null, 2);

        // 2. HTML íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (divì˜ textContentì— ë„£ì„ ë•ŒëŠ” í•„ìš” ì—†ì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´)
        // ì´ ë‹¨ê³„ë¥¼ í†µí•´ JSON ë‚´ë¶€ì˜ <mark>ì™€ ê°™ì€ HTML íƒœê·¸ê°€ ì‹¤ìˆ˜ë¡œ ë Œë”ë§ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
        const escapedText = displayJsonText.replace(/&/g, '&amp;')
                                          .replace(/</g, '&lt;')
                                          .replace(/>/g, '&gt;');
        
        // 3. ì¹˜í™˜ëœ/ê²€ìƒ‰ëœ ë‹¨ì–´ì—ë§Œ <mark> íƒœê·¸ ì‚½ì…
        // ì´ ê³¼ì •ì´ í˜•ê´‘íœ í‘œì‹œì˜ í•µì‹¬ì…ë‹ˆë‹¤.
        const regex = new RegExp(replace, 'g');
        const highlightedText = escapedText.replace(regex, `<mark>${replace}</mark>`);

        document.getElementById('jsonDisplay').innerHTML = highlightedText;
    }

    // 3. ë‹¨ì–´ ì¹˜í™˜ ë° í‘œì‹œ ê¸°ëŠ¥
    function replaceAndDisplay() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë¨¼ì € JSON íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
            return;
        }

        const findWord = document.getElementById('findWord').value.trim();
        const replaceWord = document.getElementById('replaceWord').value.trim();

        if (!findWord) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ê²€ìƒ‰í•  ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        if (!replaceWord) {
             document.getElementById('statusMessage').textContent = 'âš ï¸ ë°”ê¿€ ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }
        
        lastFindWord = findWord;
        lastReplaceWord = replaceWord;

        try {
            // **ìˆœìˆ˜ JSON ê°ì²´**ì— ì¹˜í™˜ì„ ì ìš©í•˜ì—¬ ë‹¤ìš´ë¡œë“œìš© ê°ì²´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            const countObj = { count: 0 };
            const modifiedObjectForDownload = deepReplace(
                // í˜„ì¬ ê°ì²´ë¥¼ ê¹Šì€ ë³µì‚¬í•˜ì—¬ ì¹˜í™˜ (ì—°ì† ì¹˜í™˜ ê°€ëŠ¥í•˜ë„ë¡)
                JSON.parse(JSON.stringify(currentJsonObject)),
                findWord, 
                replaceWord, 
                countObj
            );
            
            currentJsonObject = modifiedObjectForDownload; // ë‹¤ìš´ë¡œë“œë  ê°ì²´ ì—…ë°ì´íŠ¸
            const replacementCount = countObj.count; 
            
            // í™”ë©´ í‘œì‹œë¥¼ ìœ„í•´ ì¹˜í™˜ëœ ë‚´ìš©ì— í˜•ê´‘íœì„ ì ìš©í•©ë‹ˆë‹¤.
            highlightDisplayContent(currentJsonObject, findWord, replaceWord);
            
            document.getElementById('statusMessage').textContent = 
                `âœ… ë‹¨ì–´ ì¹˜í™˜ ì™„ë£Œ: "${findWord}" -> "${replaceWord}". ì´ **${replacementCount}**ê°œ ì¹˜í™˜ë¨.`;
            
            // ê²€ìƒ‰ ê²°ê³¼ë„ ì—…ë°ì´íŠ¸
            const resultDiv = document.getElementById('searchResult');
            resultDiv.innerHTML = `ì¹˜í™˜ ì™„ë£Œ: "${findWord}"(ì´)ê°€ "${replaceWord}"(ìœ¼)ë¡œ **${replacementCount}**ê°œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            resultDiv.style.display = 'block';

        } catch (error) {
            document.getElementById('statusMessage').textContent = 'âŒ ì¹˜í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
            console.error(error);
        }
    }

    // 5. ìˆ˜ì •ëœ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    function downloadJsonFile() {
        if (!currentJsonObject) {
            document.getElementById('statusMessage').textContent = 'âš ï¸ ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        // currentJsonObjectëŠ” ìˆœìˆ˜í•œ JSON ê°ì²´ì…ë‹ˆë‹¤.
        const jsonText = JSON.stringify(currentJsonObject, null, 2);
        
        const blob = new Blob([jsonText], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'modified_chat.json';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        document.getElementById('statusMessage').textContent = 'â¬‡ï¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: modified_chat.json';
    }
</script>

</body>
</html>
